services:
  ubuntu-dev:
    image: node:18-bullseye
    container_name: ubuntu-dev-container
    working_dir: /workspace
    stdin_open: true
    tty: true
    volumes:
      - /home/flerf/dockerapps/nextcloud/.nextcloud/data/flerf/files/TwitterImagesPost:/workspace/twitter_images
#      - /home/flerf/dockerapps/twitterpost/code:/workspace/twitter-bot   # <-- ADD THIS for persistent code!
    command: >
      bash -c "
        set -ex
        apt-get update &&
        apt-get install -y git wget curl nextcloud-desktop nextcloud-desktop-cmd nodejs cron &&
        if [ ! -d /workspace/twitter-bot/.git ]; then
            echo 'Cloning repository...';
            git clone https://github.com/technosaurus-club/twitter-bot.git /workspace/twitter-bot;
        else
            echo 'Repo already exists, skipping clone.';
        fi &&
        echo 'Clone completed. Contents:' &&
        ls -la /workspace/twitter-bot &&
        echo 'Setting up Nextcloud sync...' &&
        cd /workspace/twitter-bot/puppeteer &&
        chmod +x puppeteer-install.sh  &&
        ./puppeteer-install.sh &&
        cd /workspace &&
        echo '0 */5 * * * /usr/bin/xvfb-run -a node post_and_archive_improved.js >/dev/null 2>&1' >> /tmp/mycron &&
        echo '*/5 * * * * nextcloudcmd -u flerf -p a123456789A --logdebug /workspace/twitter_images http://100.107.222.38:8080/remote.php/webdav/TwitterImagesPost &&
        crontab /tmp/mycron &&
        service cron start &&
        bash
      "
    environment:
      - NODE_ENV=development
    networks:
      - dev-network

networks:
  dev-network:
    driver: bridge